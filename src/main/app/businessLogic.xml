<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:tracking="http://www.mulesoft.org/schema/mule/ee/tracking" xmlns:sfdc="http://www.mulesoft.org/schema/mule/sfdc" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:spring="http://www.springframework.org/schema/beans" version="EE-3.5.0"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.mulesoft.org/schema/mule/sfdc http://www.mulesoft.org/schema/mule/sfdc/current/mule-sfdc.xsd
http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-current.xsd
http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/tracking http://www.mulesoft.org/schema/mule/ee/tracking/current/mule-tracking-ee.xsd">

	<flow name="mainFlow" processingStrategy="synchronous" doc:name="mainFlow">
		<set-variable variableName="outputCustomObjectList"
			value="#[new java.util.ArrayList()]" doc:name="outputCustomObjectList" />
		<foreach doc:name="For Each retrieved custom object from source system">
			<enricher source="#[payload]" target="#[flowVars['idInB']]"
				doc:name="Store in variable idInB">
				<sfdc:query-single config-ref="SalesforceB"
					query="SELECT Id FROM MusicAlbum__c WHERE Name = '#[payload['Name']]'"
					doc:name="Check custom object in org B" />
			</enricher>
			<expression-component doc:name="Setting ID for Upsert"><![CDATA[if (flowVars['idInB'] instanceof NullPayload) {
                 // Remove ID as it is an insert
                 payload.remove('Id')
             } else {
                 // Add target system ID as it is an update
                 payload.put('Id', idInB['Id'])
             }]]></expression-component>
			<expression-component doc:name="Remove unnecessary fields"><![CDATA[
 	            payload.remove('LastModifiedDate');
 	            payload.remove('year__c')
             ]]></expression-component>
			<expression-component doc:name="Add Custom object to outputCustomObjectList"><![CDATA[outputCustomObjectList.add(payload);]]></expression-component>
		</foreach>
		<set-payload value="#[outputCustomObjectList]" doc:name="Set Payload to the output list" />
		<logger message="Custom objects to update/create: #[payload]"
			level="INFO" doc:name="Log custom objects to update/create" />
		<sfdc:upsert config-ref="SalesforceB" externalIdFieldName="Id"
			type="MusicAlbum__c" doc:name="Upsert custom objects in target system">
			<sfdc:objects ref="#[outputCustomObjectList]" />
		</sfdc:upsert>
	</flow>

</mule>
